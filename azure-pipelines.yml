trigger:
- main

pool:
  name: Default   # self-hosted macOS agent

variables:
  IMAGE_NAME: fastapi-app
  TAG: $(Build.BuildId)
  ACR_NAME: aksdevopsacr7

steps:
# -------------------------------------------------
# Checkout
# -------------------------------------------------
- checkout: self

# -------------------------------------------------
# Ensure buildx plugin is installed (CRITICAL FIX)
# -------------------------------------------------
- script: |
    set -e

    echo "Docker version:"
    docker version

    echo "Installing docker buildx plugin..."
    mkdir -p ~/.docker/cli-plugins

    curl -sSL https://github.com/docker/buildx/releases/download/v0.12.1/buildx-v0.12.1.darwin-amd64 \
      -o ~/.docker/cli-plugins/docker-buildx

    chmod +x ~/.docker/cli-plugins/docker-buildx

    echo "Verifying buildx:"
    docker buildx version
  displayName: Install Docker Buildx Plugin

# -------------------------------------------------
# Login to ACR using service connection
# -------------------------------------------------
- task: Docker@2
  displayName: Login to ACR
  inputs:
    command: login
    containerRegistry: azure-arc-connection

# -------------------------------------------------
# Build & Push AMD64 Image (FINAL FIX)
# -------------------------------------------------
- script: |
    set -e

    docker buildx create --name amd64builder --use || docker buildx use amd64builder

    docker buildx build \
      --platform linux/amd64 \
      -t $(ACR_NAME).azurecr.io/$(IMAGE_NAME):$(TAG) \
      --push .
  displayName: Build and Push linux/amd64 Image

# -------------------------------------------------
# Output image info
# -------------------------------------------------
- script: |
    echo "Image pushed:"
    echo "$(ACR_NAME).azurecr.io/$(IMAGE_NAME):$(TAG)"
  displayName: Image Info
